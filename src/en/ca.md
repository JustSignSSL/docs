# CA Configuration

Before deploying JustSignSSL, you need to set up your own root CA and intermediate CAs system with many different validation levels. This document will use OpenSSL as an example to describe how to generate a canonical root CA and intermediate CAs system.

::: danger
The private keys of the root CA and intermediate CAs generated by this document do not have passwords. Please pay attention to the security of the private key files, or learn to add relevant fields or parameters to the configuration files and commands to protect the private keys with passwords.
:::

## Root CA Generation

Create a new directory, such as `rootca`;

Create a file in the `rootca` directory, which can be named `rootca.cnf`, and fill in the following content:

```ini
[ ca ]
default_ca = CA_default

[ CA_default ]
dir = /home/iks/CA/rootca
certs = $dir/certs
crl_dir = $dir/crl
new_certs_dir = $dir/newcerts
database = $dir/db/index
serial = $dir/db/serial
RANDFILE = $dir/private/random
private_key = $dir/private/rootca.key.pem
certificate = $dir/certs/rootca.cert.pem
crlnumber = $dir/db/crlnumber
crl = $dir/crl/rootca.crl.pem
crl_extensions = crl_ext
default_crl_days = 30
default_md = sha256
name_opt = ca_default
cert_opt = ca_default
default_days = 3750
preserve = no
policy = policy_strict

[ policy_strict ]
countryName = supplied
stateOrProvinceName = optional
localityName = optional
organizationName = supplied
organizationalUnitName = optional
commonName = supplied

[ req ]
prompt = no
default_bits = 2048
distinguished_name = req_distinguished_name
string_mask = utf8only
default_md = sha256
x509_extensions = v3_ca

[ req_distinguished_name ]
countryName = CN
stateOrProvinceName = Sichuan
localityName = Chengdu
organizationName = Urban Readjustment Limited
organizationalUnitName = Root CA - R1
commonName = CURL Root CA

[ v3_ca ]
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid:always,issuer
basicConstraints = critical, CA:true
keyUsage = critical, digitalSignature, cRLSign, keyCertSign

[ v3_intermediate_ca ]
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid,issuer
basicConstraints = critical, CA:true, pathlen:0
keyUsage = critical, digitalSignature, cRLSign, keyCertSign
authorityInfoAccess = OCSP;URI:http://pki.iks.moe/ocsp, caIssuers;URI:http://pki.iks.moe/static/cert/CURLRootCA.crt
certificatePolicies = ia5org, @pl_section
crlDistributionPoints = URI:http://pki.iks.moe/static/crl/CURLRootCA.crl
extendedKeyUsage = serverAuth, clientAuth

[ pl_section ]
policyIdentifier = "X509v3 Any Policy"
CPS.1 = https://pki.iks.moe/CPS/CURLCA

[ crl_ext ]
authorityKeyIdentifier=keyid:always

[ ocsp ]
basicConstraints = CA:FALSE
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid,issuer
keyUsage = critical, digitalSignature
extendedKeyUsage = critical, OCSPSigning
```

Pay attention to `dir` on line 5.

Among them, please customize the following:

```ini
countryName = CN
stateOrProvinceName = Sichuan
localityName = Chengdu
organizationName = Urban Readjustment Limited
organizationalUnitName = Root CA - R1
commonName = CURL Root CA

authorityInfoAccess = OCSP;URI:http://ocsp.iks.moe, caIssuers;URI:http://pki.iks.moe/static/cert/CURLRootCA.crt
crlDistributionPoints = URI:http://pki.iks.moe/static/crl/CURLRootCA.crl

CPS.1 = https://pki.iks.moe/CPS/CURLCA
```
|Field|Corresponding|Example|Remark|
|:--|:-:|:-:|:-:|
|`countryName`|Country and Region Name|`CN`|It needs to be one of the two-digit codes listed in ISO3166, Required|
|`stateOrProvinceName`|State or Province Name|`Sichuan`|Optional|
|`localityName`|Locality Name|`Chengdu`|Optional|
|`organizationName`|Organization Name|`Urban Readjustment Limited`|Required|
|`organizationalUnitName`|Organizational Unit Name|`Root CA - R1`|Literally the name of a unit within the organization, Optional|
|`commonName`|Common Name|`CURL Root CA`|It will be directly displayed in the "Issuer" column of the certificate. The general recommended format is "Company Name" and Root CA, Required|

|Field|Content|Remark|
|:-|:-|:-:|
|`authorityInfoAccess`|`http://ocsp.iks.moe`|Your own OCSP responser address|
|`authorityInfoAccess`|`http://pki.iks.moe/static/cert/CURLRootCA.crt`|Your own root CA certificate distribution point address|
|`crlDistributionPoints`|`http://pki.iks.moe/static/crl/CURLRootCA.crl`|Your own root CA certificate revocation list distribution point address|
|`CPS.1`|`https://pki.iks.moe/CPS/CURLCA`|The repository address of your own CA system|

The protocol header of the first three items must not be `https`.

Due to the imperfect compatibility of non-ASCII characters on different hardware architectures, different operating systems, different programming languages, different applications and even different versions of applications, the author suggests that the above content should be translated into **English** and filled in.

Create four directories `certs`, `db`, `private` and `newcerts` in the `rootca` directory; create a blank file `index` in the `rootca/db` directory; then execute `openssl rand -hex 16 > rootca/db/serial`.

Enter the `rootca` directory and execute `openssl genrsa -out private/rootca.key.pem 4096` to create the private key of the root CA.

Execute the following command (please copy and paste at one time) to create a certificate signing request (CSR) for the root CA:

```shell
openssl req -new \
    -config rootca.cnf \
    -sha256 -utf8 \
    -key private/rootca.key.pem \
    -out csr/rootca.csr.pem
```

Execute `openssl req -text -noout -in csr/rootca.csr.pem` to view the content of the generated CSR.

Execute the following commands (please copy and paste at one time) to self-sign the root CA:

```shell
openssl ca -selfsign \
    -config rootca.cnf \
    -in csr/rootca.csr.pem \
    -extensions v3_ca \
    -utf8 -batch -notext \
    -days 7300 \
    -out certs/rootca.cert.pem
```

Among them, `7300` is the validity period of the certificate, generally 20 to 30 years (7300d-10950d).

Execute `openssl x509 -noout -text -in certs/rootca.cert.pem` to check the content of the generated root CA certificate.

## Intermediate CA Generation

Create three new directories at the same level as the `rootca` directory, such as `tlsdv`, `tlsov` and `tlsev`.

Create a file in each of the `tlsdv`, `tlsov` and `tlsev` directories, which can be named `powerca.cnf` and fill in the following content:

```ini
[ ca ]
default_ca = CA_default

[ CA_default ]
dir = path
certs = $dir/certs
crl_dir = $dir/crl
new_certs_dir = $dir/newcerts
database = $dir/db/index
serial = $dir/db/serial
RANDFILE = $dir/private/random
private_key = $dir/private/powerca.key.pem
certificate = $dir/certs/powerca.cert.pem
crlnumber = $dir/db/crlnumber
crl = $dir/crl/powerca.crl.pem
crl_extensions = crl_ext
default_crl_days = 7
default_md = sha256
name_opt = ca_default
cert_opt = ca_default
default_days = 3750
copy_extensions = copy
preserve = no
policy = policy_loose

[ policy_loose ]
Please replace with appropriate content.

[ req ]
prompt = no
default_bits = 2048
distinguished_name = req_distinguished_name
string_mask = utf8only
default_md = sha256
x509_extensions = v3_ca

[ req_distinguished_name ]
countryName = CN
organizationName = Urban Readjustment Limited
commonName = CURL Extended Validation Server CA - R1

[ v3_ca ]
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid:always,issuer
basicConstraints = critical, CA:true
keyUsage = critical, digitalSignature, cRLSign, keyCertSign

[ server_cert ]
Please replace with appropriate content.

[ crl_ext ]
authorityKeyIdentifier=keyid,issuer

[ pl_section ]
policyIdentifier = 2.16.840.1.114514.2.1
CPS.1 = https://pki.iks.moe/CPS/CURLCA
```

`[ policy_loose ]` and `[ server_cert ]` have different contents depending on the validation level. Among them, EV should fill in the following content:

```ini
[ policy_loose ]
commonName                = supplied
organizationName          = supplied
streetAddress             = optional
localityName              = optional
stateOrProvinceName       = supplied
postalCode                = optional
countryName               = supplied
businessCategory          = supplied
jurisdictionCountryName   = supplied
jurisdictionStateOrProvinceName = optional
jurisdictionLocalityName  = optional
serialNumber              = supplied

[ server_cert ]
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid,issuer
basicConstraints = critical, CA:false
keyUsage = critical, digitalSignature, keyEncipherment
authorityInfoAccess = OCSP;URI:http://ocsp.iks.moe, caIssuers;URI:http://pki.iks.moe/static/cert/CURLExtendedValidationServerCAR1.crt
certificatePolicies = ia5org, @pl_section, 2.23.140.1.1
crlDistributionPoints = URI:http://pki.iks.moe/static/crl/CURLExtendedValidationServerCAR1.crl
extendedKeyUsage = serverAuth, clientAuth
```

OV should fill in the following content:

```ini
[ policy_loose ]
commonName                = supplied
organizationName          = supplied
organizationalUnitName    = optional
localityName              = supplied
stateOrProvinceName       = supplied
countryName               = supplied

[ server_cert ]
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid,issuer
basicConstraints = critical, CA:false
keyUsage = critical, digitalSignature, keyEncipherment
authorityInfoAccess = OCSP;URI:http://ocsp.iks.moe, caIssuers;URI:http://pki.iks.moe/static/cert/CURLExtendedValidationServerCAR1.crt
certificatePolicies = ia5org, @pl_section, 2.23.140.1.2.2
crlDistributionPoints = URI:http://pki.iks.moe/static/crl/CURLExtendedValidationServerCAR1.crl
extendedKeyUsage = serverAuth, clientAuth
```

DV should fill in the following content:

```ini
[ policy_loose ]
commonName                = supplied

[ server_cert ]
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid,issuer
basicConstraints = critical, CA:false
keyUsage = critical, digitalSignature, keyEncipherment
authorityInfoAccess = OCSP;URI:http://ocsp.iks.moe, caIssuers;URI:http://pki.iks.moe/static/cert/CURLExtendedValidationServerCAR1.crt
certificatePolicies = ia5org, @pl_section, 2.23.140.1.2.1
crlDistributionPoints = URI:http://pki.iks.moe/static/crl/CURLExtendedValidationServerCAR1.crl
extendedKeyUsage = serverAuth, clientAuth
```

Among them, please customize the following:

```ini
countryName = CN
organizationName = Urban Readjustment Limited
commonName = CURL Extended Validation Server CA - R1

authorityInfoAccess = OCSP;URI:http://ocsp.iks.moe, caIssuers;URI:http://pki.iks.moe/static/cert/CURLExtendedValidationServerCAR1.crt
crlDistributionPoints = URI:http://pki.iks.moe/static/crl/CURLExtendedValidationServerCAR1.crl

policyIdentifier = 2.16.840.1.114514.2.1
CPS.1 = https://pki.iks.moe/CPS/CURLCA
```

Pay attention to `dir` on line 5.

|Field|Corresponding|Example|Remark|
|:--|:-:|:-:|:-:|
|`countryName`|Country and Region Name|`CN`|It needs to be one of the two-digit codes listed in ISO3166, Required|
|`organizationName`|Organization Name|`Urban Readjustment Limited`|Required|
|`commonName`|Common Name|`CURL Extended Validation Server CA - R1`|It will be directly displayed in the "Issuer" column of the certificate. The general recommended format is "Company Name" and Validation Level CA, Required|

|Field|Content|Remark|
|:-|:-|:-:|
|`authorityInfoAccess`|`http://ocsp.iks.moe`|Your own OCSP responser address|
|`authorityInfoAccess`|`http://pki.iks.moe/static/cert/CURLRootCA.crt`|Your own intermediate CA certificate distribution point address|
|`crlDistributionPoints`|`http://pki.iks.moe/static/crl/CURLRootCA.crl`|Your own intermediate CA certificate revocation list distribution point address|
|`policyIdentifier`|`114514.2.1`|Numbers you like, no more than 16 digits|
|`CPS.1`|`https://pki.iks.moe/CPS/CURLCA`|The repository address of your own CA system|

The protocol header of the first three items must not be `https`.

Due to the imperfect compatibility of non-ASCII characters on different hardware architectures, different operating systems, different programming languages, different applications and even different versions of applications, the author suggests that the above content should be translated into **English** and filled in.

Create four directories `certs`, `db`, `private` and `newcerts` under the three directories `tlsdv`, `tlsov` and `tlsev`. Then create a blank file `index` in each `db` directories. Finally, enter the three directories `tlsdv`, `tlsov` and `tlsev` respectively, and execute the `openssl rand -hex 16 > db/serial && echo "unique_subject = no" > db/index.attr`.

Enter the three directories `tlsdv`, `tlsov` and `tlsev` respectively, and execute `openssl genrsa -out private/powerca.key.pem 4096` to create the private keys of the intermediate CAs.

Enter the three directories `tlsdv`, `tlsov` and `tlsev` respectively, and execute the following commands (please copy and paste at one time) to create a certificate signing request (CSR) for the intermediate CAs:

```shell
openssl req -new \
    -config powerca.cnf \
    -sha256 -utf8 \
    -key private/powerca.key.pem \
    -out csr/powerca.csr.pem
```

Execute `openssl req -text -noout -in csr/powerca.csr.pem` to view the content of the generated CSR.

Go back to the directory where the four directories `rootca`, `tlsdv`, `tlsov` and `tlsev` are located, execute the following command (please copy and paste at one time) to sign the intermediate CAs with the root CA:

```shell
openssl ca -config rootca/rootca.cnf \
    -extensions v3_intermediate_ca \
    -days 3650 -notext -md sha256 \
    -utf8 -batch \
    -in tlsev/csr/powerca.csr.pem \
    -out tlsev/certs/powerca.cert.pem
```

Among them, `tlsev` should be replaced with `tlsov` and `tlsev` in the 2nd and 3rd execution; `3650` is the validity period of the certificate, generally 10 years (3650d).

Execute `openssl x509 -noout -text -in certs/rootca.cert.pem` to check the contents of the intermediate CAs certificate signed with the root CA.

So far, the root CA and intermediate CAs system have been generated.
